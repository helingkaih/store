<div class="dg-paragraph"><code>Store</code> is a single object containing state and behavior, and also a common service. to create a <code>Store</code>, you need to extends the <code>Store&lt;TState&gt;</code>, pass in the current Store&#39;s state type definition through generics, and call the parent class constructor through <code>super()</code> to set the initialization state.</div>
<pre class="language-ts"><code class="language-ts"><div><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Action<span class="token punctuation">,</span> Store <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@tethys/store'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> of <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> tap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">CounterState</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterStore</span> <span class="token keyword">extends</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>CounterState<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>

        <h2 id="update" class="docs-header-link">
          <span header-link="update"></span>
          update
        </h2>
      <p>We can call the <code>update()</code> method to transfer in the new state.</p>
<pre class="language-ts"><code class="language-ts"><div>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterStore</span> <span class="token keyword">extends</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>CounterState<span class="token operator">></span> <span class="token punctuation">{</span>
    
    <span class="token operator">...</span>

    @<span class="token function">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshot<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>
<div class="dg-paragraph"><code>update</code> support multiple parameter types:</div>
<ul>
<li>New fully <code>State</code> object</li>
<li>Partial <code>State</code> updated objects</li>
<li>The function return the new <code>State</code> object</li>
</ul>
<pre class="language-ts"><code class="language-ts"><div>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterStore</span> <span class="token keyword">extends</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>CounterState<span class="token operator">></span> <span class="token punctuation">{</span>
    @<span class="token function">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>

        <h2 id="snapshot" class="docs-header-link">
          <span header-link="snapshot"></span>
          snapshot
        </h2>
      <p>提供存当前<code>Store</code>状态的快照，方便在模版中通过<code>store.snapshot</code>表达式直接访问, 使用<code>snapshot</code>的时候需要注意:</p>
<ul>
<li>尽量只在模版中使用，数据变化后非<code>OnPush</code>模式的组件可以通过变更检测实时响应</li>
<li>在代码中使用时确定当前时刻一定是你需要的值, 且是一次性使用, 数据变更后不影响当前逻辑</li>
<li>严禁在<code>Store</code>外直接修改<code>snapshot</code>中的数据</li>
<li><code>OnPush</code>组件禁止使用<code>snapshot</code>, 否则数据变更后无法同步视图
<alert>使用 snapshot 的时候一定要了解 Angular 数据变更机制，否则非常容易造成数据不同步的缺陷。</alert></li>
</ul>

        <h2 id="getstate" class="docs-header-link">
          <span header-link="getstate"></span>
          getState
        </h2>
      <p>alias function return snapshot.</p>
<pre class="language-ts"><code class="language-ts"><div><span class="token keyword">const</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></code></pre>

        <h2 id="select" class="docs-header-link">
          <span header-link="select"></span>
          select
        </h2>
      <p>一个<code>Store</code>可以存储多个数据集，当某个组件只需要获取部分数据时，可以通过<code>select()</code>函数过滤需要的数据，这样只有过滤的数据变化才会收到变化订阅，提高应用程序的性能。</p>
<pre class="language-ts"><code class="language-ts"><div>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token punctuation">:</span> <span class="token string">'thy-store-counter'</span><span class="token punctuation">,</span>
    templateUrl<span class="token punctuation">:</span> <span class="token string">'./counter.component.html'</span><span class="token punctuation">,</span>
    styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./counter.component.scss'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ThyStoreCounterExampleComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
    count$<span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span><span class="token keyword">number</span><span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> counter<span class="token punctuation">:</span> CounterStore<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> state<span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>
<p>注意事项：</p>
<ul>
<li>推荐使用<code>select</code>返回需要的<code>Observable</code>, 在模版中使用<code>async</code>管道订阅使用, 如果模版中多处使用可以使用<code>as</code>关键字保存为临时对象</li>
<li>一旦在代码中订阅使用, 一定要取消订阅, 推荐<code>takeUntil</code>操作符取消订阅</li>
<li><code>selector</code>推荐统一定义到<code>Store</code>的静态函数中, 提高性能的话在最后添加<code>shareReplay</code>管道是一个不错的好习惯</li>
</ul>

        <h2 id="storeoptions" class="docs-header-link">
          <span header-link="storeoptions"></span>
          StoreOptions
        </h2>
      <p>The first parameter of the Store constructor is the initial state, and the second parameter is <code>StoreOptions</code>. currently, the configuration name and the maximum number of instances are supported:</p>
<ul>
<li><code>name: string</code>: Define name of store, default name is generated according to the class name, e.g. class ZoomStore name is <code>ZoomStore</code>, In production environment, js will be compressed and confused, so it is recommended to give each store a unique name.</li>
<li><code>instanceMaxCount: number</code>: The max number of instances for the current store, default 20, set to 0 means unlimited, Note: only throw error in devMode, unlimited in production environment.</li>
</ul>
<pre class="language-ts"><code class="language-ts"><div>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterStore</span> <span class="token keyword">extends</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>CounterState<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"CounterStore"</span><span class="token punctuation">,</span>  instanceMaxCount<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>

        <h2 id="getstores" class="docs-header-link">
          <span header-link="getstores"></span>
          getStores
        </h2>
      <div class="dg-paragraph"><code>StoreFactory</code>的<code>getStores(names: string | string[])</code>方法，可以通过<code>Store</code>名字，取到注册过的所有<code>Store</code>。</div>
<pre class="language-ts"><code class="language-ts"><div><span class="token keyword">import</span> <span class="token punctuation">{</span> StoreFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@tethys/store'</span><span class="token punctuation">;</span>

<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> storeFactory<span class="token punctuation">:</span> StoreFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stores <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeFactory<span class="token punctuation">.</span><span class="token function">getStores</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ItemsStore'</span><span class="token punctuation">,</span> <span class="token string">'AnotherItemsStore'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></div></code></pre>
