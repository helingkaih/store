<div class="dg-paragraph"><code>Store</code>是一个包含状态和行为的单一对象，也是一个普通的服务，创建<code>Store</code>只需继承<code>Store&lt;TState&gt;</code>，并通过泛型传入当前<code>Store</code>存储的状态类型定义，同时通过<code>super()</code>调用父类构造函数设置初始化状态。</div>
<pre class="language-ts"><code class="language-ts"><div><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Action<span class="token punctuation">,</span> Store <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@tethys/store'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> of <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> tap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">CounterState</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterStore</span> <span class="token keyword">extends</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>CounterState<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>

        <h2 id="setstate" class="docs-header-link">
          <span header-link="setstate"></span>
          setState
        </h2>
      <p>当需要更新状态时可以通过调用<code>setState()</code>方法传入新的状态。</p>
<pre class="language-ts"><code class="language-ts"><div>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterStore</span> <span class="token keyword">extends</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>CounterState<span class="token operator">></span> <span class="token punctuation">{</span>
    
    <span class="token operator">...</span>

    @<span class="token function">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshot<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>
<div class="dg-paragraph"><code>setState</code> 可以支持多种参数类型</div>
<ul>
<li>完整的<code>State</code>新对象</li>
<li>部分<code>State</code>更新的对象</li>
<li>返回新<code>State</code>的函数</li>
</ul>
<pre class="language-ts"><code class="language-ts"><div>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterStore</span> <span class="token keyword">extends</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>CounterState<span class="token operator">></span> <span class="token punctuation">{</span>
    @<span class="token function">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>

        <h2 id="snapshot" class="docs-header-link">
          <span header-link="snapshot"></span>
          snapshot
        </h2>
      <p>提供存当前<code>Store</code>状态的快照，方便在模版中通过<code>store.snapshot</code>表达式直接访问, 使用<code>snapshot</code>的时候需要注意:</p>
<ul>
<li>尽量只在模版中使用，数据变化后非<code>OnPush</code>模式的组件可以通过变更检测实时响应</li>
<li>在代码中使用时确定当前时刻一定是你需要的值, 且是一次性使用, 数据变更后不影响当前逻辑</li>
<li>严禁在<code>Store</code>外直接修改<code>snapshot</code>中的数据</li>
<li><code>OnPush</code>组件禁止使用<code>snapshot</code>, 否则数据变更后无法同步视图
<alert>使用 snapshot 的时候一定要了解 Angular 数据变更机制，否则非常容易造成数据不同步的缺陷。</alert></li>
</ul>

        <h2 id="select" class="docs-header-link">
          <span header-link="select"></span>
          select
        </h2>
      <p>一个<code>Store</code>可以存储多个数据集，当某个组件只需要获取部分数据时，可以通过<code>select()</code>函数过滤需要的数据，这样只有过滤的数据变化才会收到变化订阅，提高应用程序的性能。</p>
<pre class="language-ts"><code class="language-ts"><div>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token punctuation">:</span> <span class="token string">'thy-store-counter'</span><span class="token punctuation">,</span>
    templateUrl<span class="token punctuation">:</span> <span class="token string">'./counter.component.html'</span><span class="token punctuation">,</span>
    styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./counter.component.scss'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ThyStoreCounterExampleComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
    count$<span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span><span class="token keyword">number</span><span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> counter<span class="token punctuation">:</span> CounterStore<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> state<span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></div></code></pre>
<p>注意事项：</p>
<ul>
<li>推荐使用<code>select</code>返回需要的<code>Observable</code>, 在模版中使用<code>async</code>管道订阅使用, 如果模版中多处使用可以使用<code>as</code>关键字保存为临时对象</li>
<li>一旦在代码中订阅使用, 一定要取消订阅, 推荐<code>takeUntil</code>操作符取消订阅</li>
<li><code>selector</code>推荐统一定义到<code>Store</code>的静态函数中, 提高性能的话在最后添加<code>shareReplay</code>管道时一个不错的好习惯</li>
</ul>
